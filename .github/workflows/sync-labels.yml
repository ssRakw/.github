name: ğŸ” Label Sync

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”'
        required: true
        type: choice
        default: 'download_test'
        options:
          - 'download_test'
          - 'apply_labels'

permissions:
  issues: write
  contents: read

jobs:
  test-download:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'download_test'
    
    steps:
      - name: ğŸ§ª Test 1 - ê¸°ë³¸ curlë¡œ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
        run: |
          echo "============================================="
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ 1: í† í° ì—†ì´ ë‹¤ìš´ë¡œë“œ ì‹œë„"
          echo "============================================="
          
          if curl -f -s -o labels.yml https://raw.githubusercontent.com/MakeChatStudy/.github/main/labels/labels.yml; then
            echo "âœ… ë‹¤ìš´ë¡œë“œ ì„±ê³µ!"
            echo "ğŸ“„ íŒŒì¼ í¬ê¸°: $(wc -c < labels.yml) bytes"
            echo "ğŸ“„ ë¼ì¸ ìˆ˜: $(wc -l < labels.yml) lines"
            echo ""
            echo "ğŸ“‹ íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
            head -10 labels.yml
          else
            echo "âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            echo "curl ì¢…ë£Œ ì½”ë“œ: $?"
          fi

      - name: ğŸ§ª Test 2 - ìƒì„¸ ì •ë³´ë¡œ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
        run: |
          echo ""
          echo "============================================="
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ 2: ìƒì„¸ ì •ë³´ì™€ í•¨ê»˜ ë‹¤ìš´ë¡œë“œ"
          echo "============================================="
          
          echo "ğŸ“¡ URL ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸:"
          curl -I https://raw.githubusercontent.com/MakeChatStudy/.github/main/labels/labels.yml
          
          echo ""
          echo "ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì‹œë„ (ìƒì„¸ ë¡œê·¸):"
          curl -v -f -o labels-test.yml https://raw.githubusercontent.com/MakeChatStudy/.github/main/labels/labels.yml
          
          if [ -f labels-test.yml ]; then
            echo "âœ… Test 2 ì„±ê³µ!"
            echo "ğŸ“Š íŒŒì¼ ì •ë³´:"
            ls -la labels-test.yml
          else
            echo "âŒ Test 2 ì‹¤íŒ¨"
          fi

      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        run: |
          echo ""
          echo "============================================="
          echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
          echo "============================================="
          
          if [ -f labels.yml ] && [ -f labels-test.yml ]; then
            echo "ğŸ‰ ë‘ í…ŒìŠ¤íŠ¸ ëª¨ë‘ ì„±ê³µ!"
            echo "âœ… í† í° ì—†ì´ íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥"
            echo "â¡ï¸ ë‹¤ìŒ ë‹¨ê³„: apply_labels ëª¨ë“œë¡œ ì‹¤ì œ ë¼ë²¨ ì ìš© í…ŒìŠ¤íŠ¸"
          elif [ -f labels.yml ] || [ -f labels-test.yml ]; then
            echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ë§Œ ì„±ê³µ"
            echo "ğŸ”„ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ - ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”"
          else
            echo "âŒ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            echo "ğŸ” í† í°ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            echo "â¡ï¸ ë‹¤ìŒ ë‹¨ê³„: Personal Access Token ì„¤ì •"
          fi

  apply-labels:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'apply_labels'
    
    steps:
      - name: ğŸ“¥ ì¡°ì§ ë¼ë²¨ ë‹¤ìš´ë¡œë“œ
        run: |
          echo "============================================="
          echo "ğŸ“¥ ì¡°ì§ í‘œì¤€ ë¼ë²¨ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          echo "============================================="
          
          if curl -f -s -o labels.yml https://raw.githubusercontent.com/MakeChatStudy/.github/main/labels/labels.yml; then
            echo "âœ… ë‹¤ìš´ë¡œë“œ ì„±ê³µ!"
            echo ""
            echo "ğŸ“‹ ì ìš©ë  ë¼ë²¨ ëª©ë¡:"
            grep "name:" labels.yml | head -10
            echo "... (ì´ $(grep -c "name:" labels.yml)ê°œ ë¼ë²¨)"
          else
            echo "âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!"
            echo "ğŸ›‘ ë¼ë²¨ ì ìš©ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          fi

      - name: ğŸ·ï¸ ë¼ë²¨ ì ìš©
        uses: crazy-max/ghaction-github-labeler@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          yaml-file: labels.yml
          skip-delete: false

      - name: ğŸ‰ ì™„ë£Œ ì•ˆë‚´
        run: |
          echo "============================================="
          echo "ğŸ‰ ë¼ë²¨ ë™ê¸°í™” ì™„ë£Œ!"
          echo "============================================="
          echo "âœ… MakeChatStudy ì¡°ì§ í‘œì¤€ ë¼ë²¨ ì ìš©ë¨"
          echo "ğŸ“‹ Issues â†’ Labelsì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”"
          echo ""
          echo "ğŸ“Š í˜„ì¬ ë¼ë²¨ ìˆ˜: $(curl -s -H 'Authorization: token ${{ secrets.GITHUB_TOKEN }}' https://api.github.com/repos/${{ github.repository }}/labels | jq length 2>/dev/null || echo 'í™•ì¸ ì¤‘...')"
